---
Author: Thomas Verliefde
Date: '2019-04-09'
Output: html_document
Title: Analyses AmbDiff
editor_options:
  chunk_output_type: console
version: '0.1'
---

TODO: Check all variables whether they are what they should be (factor, numeric, ...)
TODO: Additional analysis with control variables (keyfirst, otherfirst, gender, ...)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
# load("20190319.RData")
```

```{r libraries, include=FALSE}
lapply(
  c("plyr","dplyr","tidyr","ggplot2","readxl","readr","lme4","afex","lmerTest",
    "emmeans","purrr","magrittr","cowplot"),
  require,
  character.only = T
)
```

##################
# Data Wrangling #
##################

```{r import, cache=FALSE}

temp <- tempdir()
df_raw <- "Data_AmbDiff.zip" %>% {
  ldply(
    .data = unzip(.,list=T) %$%
      grep("(.csv)$",Name,value=TRUE),
    .fun = function(x) unzip(.,files=x,exdir=temp) %>%
      read_csv
  ) %>% as_tibble %>% arrange(Subject)
}
rm(temp)

```

```{r !, options}

# utils::View(df_raw)
seq(1,80) %in% df_raw$Subject %>% not %>% which
"Data_AmbDiff.zip" %>% unzip(list=T) %>% arrange(Date) %>%
  filter(grepl("(.csv)$",.$Name)) %>% extract(44:50,c(1,3))

```

Participant 48's data is missing ...

Comments from during data collection:
*Subject 20 was remarkably quick
*Subject 44 stated to already know the experiment - will be excluded
*Subject 59 stated to already know the experiment - will be excluded
*Subject 60 had to restart the experiment once

```{r df, options}

df <- df_raw %>%
  select(
    grep("(^time)|(hostName)|(Primes$)|(Trials$)",colnames(.),invert=TRUE)
  ) %>%
  gather(
    key = "key",
    value = "value",
    grep("(^practice)|(^experiment)",colnames(.))
  ) %>%
  separate(
    key,
    c("Exp","key"),
    sep="_",
    extra = "merge"
  ) %>%
  separate(
    key,
    c("Block","Trial","key"),
    sep="_",
    fill="left"
  ) %>%
  spread(
    key,
    value
  ) %>%
  arrange(
    Subject,Block,as.numeric(Trial)
  ) %>%
  mutate(
    Subject = Subject %>% as.factor
  ) %>%
  group_by(
    Subject
  ) %>%
  mutate(
    Gender = recode(
      Gender,
      "weiblich" = "Female",
      "mÃ¤nnlich" = "Male",
      .default = "Other"
    ),
    Language = recode(
      Language,
      "Deutsch" = "German",
      "Sonstiges" = "Other"
    ),
    Handedness = recode(
      Handedness,
      "rechts" = "Right",
      "links" = "Left",
      "beide" = "Both"
    ),
    Block = Block %>% as.factor,
    Trial = Trial %>% as.numeric,
    Response = case_when(
      answer == 'Y' & Key == 'Yneg' ~ 'Negative',
      answer == 'OemMinus' & Key == 'Ypos' ~ 'Negative',
      TRUE ~ 'Positive'
    ),
    primeCat = recode(
      primeCat,
      "0" = "Ambivalent",
      "1" = "Positive",
      "2" = "Negative",
      "3" = "Neutral"
    ),
    targetCat = recode(
      targetCat,
      "0" = "Positive",
      "1" = "Negative"
    ),
    RT = time %>% as.numeric,
    logRT = log(RT),
    Correct = Response == targetCat,
    Accuracy = mean(Correct),
    speedIncl = (RT >= 300 & RT <= 3000),
    #Trials with latencies smaller than 300ms or larger than 3000ms were excluded.
    accIncl = (1 - mean(speedIncl & Correct)) < 0.83,
    ruleIncl = (Subject %in% c(44,59,60)) %>% not,
    subjIncl = accIncl & ruleIncl,
    trialIncl = Correct & speedIncl,
    Inclusion = trialIncl & subjIncl
  ) %>%
  select(
    everything(),
    answerCode = answer,
    Prime = prime,
    Target = target,
    -time
  ) %>% ungroup

# utils::View(df)
```

```{r subsets, options}

df_sub <- df %>%
  distinct(
    Subject,Age,Gender,Language,Handedness,Study,Key,Accuracy,accIncl,ruleIncl,subjIncl
  )

df_practice <- df %>%
  filter(Exp == "practice") %>%
  select(
    Subject,Key,Trial
  )

df_exp <- df %>%
  filter(Exp == "experiment") %>%
  select(
    Subject,Key,Block,Trial
  )



```

################
# Demographics #
################

```{r exclusions, options}

df_sub %>%
  filter(accIncl %>% not) %>%
  nrow %>%
  paste("participants were excluded due to extremes in accuracy and/or latency.")

df_sub %>%
  filter(ruleIncl %>% not) %>%
  nrow %>%
  paste("participants were excluded due to issues during data collection.")
# 2 participants indicated to have already performed the experiment before.
# 1 participant had to restart the program during experimentation.

df_sub %>%
  filter(subjIncl) %>%
  nrow %>%
  paste("participants were included for the analyses.")
  
```